{"version":3,"file":"multipart-uploader.js","sourceRoot":"","sources":["multipart-uploader.ts"],"names":[],"mappings":";;;;;;;YAEA;gBAQE,2BAAmB,OAAW;oBAAX,YAAO,GAAP,OAAO,CAAI;oBAJvB,gBAAW,GAAW,KAAK,CAAC;oBAC5B,aAAQ,GAAU,CAAC,CAAC;oBACpB,YAAO,GAAW,IAAI,CAAC;oBAG5B,gCAAgC;oBAChC,IAAI,CAAC,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC;oBACvB,IAAI,CAAC,SAAS,GAAG,OAAO,CAAC,SAAS,CAAC;gBACrC,CAAC;gBAEM,sCAAU,GAAjB,UAAkB,IAAkB;oBAClC,OAAO,CAAC,KAAK,CAAC,2CAA2C,CAAC,CAAC;oBAC3D,EAAE,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;wBACrB,OAAO,CAAC,KAAK,CAAC,iEAAiE,CAAC,CAAC;wBACjF,MAAM,CAAC;oBACT,CAAC;oBACD,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;oBACxB,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;gBAC3B,CAAC;gBAEO,+CAAmB,GAA3B,UAA4B,IAAQ;oBAClC,IAAI,CAAC,eAAe,EAAE,CAAC;gBACzB,CAAC;gBAEO,yCAAa,GAArB,UAAsB,OAAW;oBAC/B,IAAI,MAAM,GAAO,EAAE,EAAE,GAAO,EAAE,GAAO,EAAE,CAAK,CAAC;oBAE7C,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;wBACb,MAAM,CAAC,MAAM,CAAC;oBAChB,CAAC;oBAED,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,UAAC,IAAQ;wBAC/B,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;wBACtB,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC;wBAC5C,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;wBAE/B,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;4BACR,MAAM,CAAC,GAAG,CAAC,GAAG,MAAM,CAAC,GAAG,CAAC,GAAG,MAAM,CAAC,GAAG,CAAC,GAAG,IAAI,GAAG,GAAG,GAAG,GAAG,CAAC;wBAC7D,CAAC;oBACH,CAAC,CAAC,CAAC;oBAEH,MAAM,CAAC,MAAM,CAAC;gBAChB,CAAC;gBAEO,8CAAkB,GAA1B,UAA2B,QAAY,EAAE,OAAW;oBAClD,MAAM,CAAC,QAAQ,CAAC;gBAClB,CAAC;gBAEO,0CAAc,GAAtB,UAAuB,MAAU;oBAC/B,MAAM,CAAC,CAAC,MAAM,IAAI,GAAG,IAAI,MAAM,GAAG,GAAG,CAAC,IAAI,MAAM,KAAK,GAAG,CAAC;gBAC3D,CAAC;gBAEO,mCAAO,GAAf;oBACE,UAAU;gBACZ,CAAC;gBAED,yCAAa,GAAb,UAAc,IAAQ;oBAAtB,iBAkDC;oBAhDC,OAAO,CAAC,KAAK,CAAC,8CAA8C,CAAC,CAAC;oBAE9D,IAAI,GAAG,GAAG,IAAI,CAAC,IAAI,GAAG,IAAI,cAAc,EAAE,CAAC;oBAE3C,kCAAkC;oBAClC,uDAAuD;oBACvD,GAAG;oBAEH,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC;oBAE/B,GAAG,CAAC,MAAM,CAAC,UAAU,GAAG,UAAC,KAAK;oBAC9B,CAAC,CAAC;oBAEF,GAAG,CAAC,MAAM,GAAG;wBACX,OAAO,CAAC,KAAK,CAAC,oDAAoD,CAAC,CAAC;wBACpE,IAAI,OAAO,GAAG,KAAI,CAAC,aAAa,CAAC,GAAG,CAAC,qBAAqB,EAAE,CAAC,CAAC;wBAC9D,IAAI,QAAQ,GAAG,KAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;wBAC9D,IAAI,IAAI,GAAG,KAAI,CAAC,cAAc,CAAC,GAAG,CAAC,MAAM,CAAC,GAAG,SAAS,GAAG,OAAO,CAAC;wBACjE,IAAI,MAAM,GAAG,KAAK,GAAG,IAAI,GAAG,MAAM,CAAC;wBAC7B,KAAK,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,QAAQ,EAAE,GAAG,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;wBACzD,KAAI,CAAC,eAAe,CAAC,IAAI,EAAE,QAAQ,EAAE,GAAG,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;oBAC5D,CAAC,CAAC;oBAEF,GAAG,CAAC,OAAO,GAAG;wBACZ,OAAO,CAAC,KAAK,CAAC,qDAAqD,CAAC,CAAC;wBACrE,IAAI,OAAO,GAAG,KAAI,CAAC,aAAa,CAAC,GAAG,CAAC,qBAAqB,EAAE,CAAC,CAAC;wBAC9D,IAAI,QAAQ,GAAG,KAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;wBAC9D,KAAI,CAAC,YAAY,CAAC,IAAI,EAAE,QAAQ,EAAE,GAAG,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;wBACvD,4DAA4D;oBAC9D,CAAC,CAAC;oBAEF,GAAG,CAAC,OAAO,GAAG;wBACZ,OAAO,CAAC,KAAK,CAAC,qDAAqD,CAAC,CAAC;wBACrE,IAAI,OAAO,GAAG,KAAI,CAAC,aAAa,CAAC,GAAG,CAAC,qBAAqB,EAAE,CAAC,CAAC;wBAC9D,IAAI,QAAQ,GAAG,KAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;wBAC9D,0DAA0D;wBAC1D,KAAI,CAAC,eAAe,CAAC,IAAI,EAAE,QAAQ,EAAE,GAAG,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;oBAC5D,CAAC,CAAC;oBAEF,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;oBACtC,GAAG,CAAC,eAAe,GAAG,IAAI,CAAC,eAAe,CAAC;oBAE3C,EAAE,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC;wBACnB,GAAG,CAAC,gBAAgB,CAAC,eAAe,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;oBACxD,CAAC;oBACD,OAAO,CAAC,KAAK,CAAC,iDAAiD,CAAC,CAAC;oBACjE,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;oBACxB,IAAI,CAAC,OAAO,EAAE,CAAC;gBACjB,CAAC;gBAEM,yCAAa,GAApB,UAAqB,IAAQ,EAAE,QAAY,EAAE,MAAU,EAAE,OAAW;gBACpE,CAAC;gBAEM,uCAAW,GAAlB,UAAmB,IAAQ,EAAE,QAAY,EAAE,MAAU,EAAE,OAAW;oBAChE,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;gBAC3B,CAAC;gBAEM,wCAAY,GAAnB,UAAoB,IAAQ,EAAE,QAAY,EAAE,MAAU,EAAE,OAAW;gBACnE,CAAC;gBAEM,0CAAc,GAArB,UAAsB,IAAQ,EAAE,QAAY,EAAE,MAAU,EAAE,OAAW;gBACrE,CAAC;gBAEO,0CAAc,GAAtB,UAAuB,IAAQ,EAAE,QAAY,EAAE,MAAU,EAAE,OAAW;oBACpE,IAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;oBAC3C,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;gBACtD,CAAC;gBAEM,wCAAY,GAAnB,UAAoB,IAAQ,EAAE,QAAY,EAAE,MAAU,EAAE,OAAW;oBACjE,OAAO,CAAC,KAAK,CAAC,4CAA4C,GAAG,gBAAgB,GAAG,MAAM,CAAC,CAAC;oBACxF,IAAI,CAAC,QAAQ,CAAC,QAAQ,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;oBACzC,IAAI,CAAC,WAAW,CAAC,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;gBACpD,CAAC;gBAEO,yCAAa,GAArB,UAAsB,IAAQ,EAAE,QAAY,EAAE,MAAU,EAAE,OAAW;oBACnE,IAAI,CAAC,SAAS,CAAC,QAAQ,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;oBAC1C,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;gBACrD,CAAC;gBAEM,2CAAe,GAAtB,UAAuB,IAAQ,EAAE,QAAY,EAAE,MAAU,EAAE,OAAW;oBACpE,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;oBAC5C,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;oBAErD,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;oBAEzB,2CAA2C;oBAC3C,IAAI,CAAC,OAAO,EAAE,CAAC;gBACjB,CAAC;gBACH,wBAAC;YAAD,CAAC,AAtJD,IAsJC;YAtJD,iDAsJC,CAAA","sourcesContent":["import {MultipartItem} from \"./multipart-item\";\n\nexport class MultipartUploader {\n\t\n  public url:string;\n  public authToken:string;\n  public isUploading:boolean = false;\n  public progress:number = 0;\n  public isHTML5:boolean = true;\n\n  constructor(public options:any) {\n    // Object.assign(this, options);\n    this.url = options.url;\n    this.authToken = options.authToken;\n  }\n\n  public uploadItem(item:MultipartItem) {\n    console.debug(\"multipart-uploader.ts & uploadItem() ==>.\");\n    if (this.isUploading) {\n      console.debug(\"multipart-uploader.ts & uploadItem() uploader is uploading now.\");\n      return;\n    }\n    this.isUploading = true;\n    this._xhrTransport(item);\n  }\n\n  private _onBeforeUploadItem(item:any) {\n    item._onBeforeUpload();\n  }\n\n  private _parseHeaders(headers:any) {\n    let parsed:any = {}, key:any, val:any, i:any;\n\n    if (!headers) {\n      return parsed;\n    }\n\n    headers.split('\\n').map((line:any) => {\n      i = line.indexOf(':');\n      key = line.slice(0, i).trim().toLowerCase();\n      val = line.slice(i + 1).trim();\n\n      if (key) {\n        parsed[key] = parsed[key] ? parsed[key] + ', ' + val : val;\n      }\n    });\n\n    return parsed;\n  }\n\n  private _transformResponse(response:any, headers:any):any {\n    return response;\n  }\n\n  private _isSuccessCode(status:any) {\n    return (status >= 200 && status < 300) || status === 304;\n  }\n\n  private _render() {\n    // todo: ?\n  }\n\n  _xhrTransport(item:any) {\n\t  \n    console.debug(\"multipart-uploader.ts & _xhrTransport() ==>.\");\n\n    let xhr = item._xhr = new XMLHttpRequest();\n\n    //if (item.formData.length === 0){\n    //  throw new TypeError('Invalid form,form is empty.');\n    //}\n\n    this._onBeforeUploadItem(item);\n\n    xhr.upload.onprogress = (event) => {\n    };\n\n    xhr.onload = () => {\n      console.debug(\"multipart-uploader.ts & _xhrTransport.onload() ==>\");\n      let headers = this._parseHeaders(xhr.getAllResponseHeaders());\n      let response = this._transformResponse(xhr.response, headers);\n      let gist = this._isSuccessCode(xhr.status) ? 'Success' : 'Error';\n      let method = '_on' + gist + 'Item';\n      (<any>this)[method](item, response, xhr.status, headers);\n      this._onCompleteItem(item, response, xhr.status, headers);\n    };\n\n    xhr.onerror = () => {\n      console.debug(\"multipart-uploader.ts & _xhrTransport.onerror() ==>\");\n      let headers = this._parseHeaders(xhr.getAllResponseHeaders());\n      let response = this._transformResponse(xhr.response, headers);\n      this._onErrorItem(item, response, xhr.status, headers);\n      //this._onCompleteItem(item, response, xhr.status, headers);\n    };\n\n    xhr.onabort = () => {\n      console.debug(\"multipart-uploader.ts & _xhrTransport.onabort() ==>\");\n      let headers = this._parseHeaders(xhr.getAllResponseHeaders());\n      let response = this._transformResponse(xhr.response, headers);\n      //this._onCancelItem(item, response, xhr.status, headers);\n      this._onCompleteItem(item, response, xhr.status, headers);\n    };\n\n    xhr.open(item.method, this.url, true);\n    xhr.withCredentials = item.withCredentials;\n\n    if (this.authToken) {\n      xhr.setRequestHeader('Authorization', this.authToken);\n    }\n    console.debug(\"multipart-uploader.ts & _xhrTransport() send...\");\n    xhr.send(item.formData);\n    this._render();\n  }\n\n  public onSuccessItem(item:any, response:any, status:any, headers:any) {\n  }\n\n  public onErrorItem(item:any, response:any, status:any, headers:any) {\n    this.isUploading = false;\n  }\n\n  public onCancelItem(item:any, response:any, status:any, headers:any) {\n  }\n\n  public onCompleteItem(item:any, response:any, status:any, headers:any) {\n  }\n\n  private _onSuccessItem(item:any, response:any, status:any, headers:any) {\n    item._onSuccess(response, status, headers);\n    this.onSuccessItem(item, response, status, headers);\n  }\n\n  public _onErrorItem(item:any, response:any, status:any, headers:any) {\n    console.debug(\"multipart-uploader.ts & _onErrorItem() ==>\" + \" Error status:\" + status);\n    item._onError(response, status, headers);\n    this.onErrorItem(item, response, status, headers);\n  }\n\n  private _onCancelItem(item:any, response:any, status:any, headers:any) {\n    item._onCancel(response, status, headers);\n    this.onCancelItem(item, response, status, headers);\n  }\n\n  public _onCompleteItem(item:any, response:any, status:any, headers:any) {\n    item._onComplete(response, status, headers);\n    this.onCompleteItem(item, response, status, headers);\n\n    this.isUploading = false;\n\n    //this.progress = this._getTotalProgress();\n    this._render();\n  }\n}\n"]}